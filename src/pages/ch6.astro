---
export const prerender = true;
import ChapterLayout from '../layouts/ChapterLayout.astro';
import { chapters } from '../data/chapters';
import FadeInBlock from '../components/scroll/FadeInBlock';
import AccentBar from '../components/ui/AccentBar';
import ConceptCard from '../components/ui/ConceptCard';
import Divider from '../components/ui/Divider';
import AgentBlueprint from '../components/widgets/ch6/AgentBlueprint';
import FailureModesLab from '../components/widgets/ch6/FailureModesLab';
import HandoffChain from '../components/widgets/ch6/HandoffChain';

const chapter = chapters[5];
---

<ChapterLayout chapter={chapter}>

  <!-- ═══ HERO ═══ -->
  <section class="min-h-[80vh] flex flex-col items-center justify-end px-6 pb-20 relative overflow-hidden">
    <!-- Giant background number -->
    <div class="chapter-number" style={`color: ${chapter.accent};`}>6</div>

    <div class="max-w-[680px] mx-auto text-center relative z-10">
      <FadeInBlock client:visible>
        <p class="text-[13px] italic text-subtle/60 mb-5" style="font-family: var(--font-body);">
          Chapter Six
        </p>
      </FadeInBlock>

      <FadeInBlock client:visible delay={0.15}>
        <h1
          class="mb-8 leading-[1.08]"
          style={`font-family: var(--font-heading); color: ${chapter.accent}; font-size: clamp(2.8rem, 7vw, 4.5rem); font-weight: 800; letter-spacing: -0.03em;`}
        >
          Building<br />Agents
        </h1>
      </FadeInBlock>

      <FadeInBlock client:visible delay={0.3}>
        <p class="text-lg md:text-xl italic text-deep/40 leading-relaxed max-w-sm mx-auto" style="font-family: var(--font-body);">
          Design, wire, and deploy an AI agent<br />from scratch.
        </p>
      </FadeInBlock>
    </div>

    <!-- Scroll cue -->
    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 opacity-20 animate-pulse">
      <div class="w-px h-10 bg-deep/40"></div>
    </div>
  </section>

  <!-- ═══ STORY OPENER — with drop cap ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 pt-24 pb-16">
    <FadeInBlock client:visible>
      <p class="drop-cap text-lg leading-[1.85] mb-8">
        A chatbot waits for you to speak. An agent doesn't. Give it a goal — "research Mars colonization and write a report" — and it breaks the work into steps, picks the right tools, executes them one by one, checks its own results, and keeps going until the job is done. No hand-holding required.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-8">
        That distinction — between <em>responding to instructions</em> and <em>pursuing a goal</em> — is the difference between a calculator and a coworker. Chatbots answer questions. Agents solve problems.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.2}>
      <p class="text-lg leading-[1.85]">
        This chapter is about how agents actually work under the hood — the loop that drives them, the architecture that makes them reliable, and the failure modes that make them dangerous when built carelessly.
      </p>
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ THE AGENT LOOP ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <AccentBar color={chapter.accent} className="w-16 mb-10" client:visible />
      <h2 class="mb-8" style="font-family: var(--font-heading); letter-spacing: -0.02em;">
        The Agent Loop
      </h2>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-10">
        Every AI agent — from a simple research bot to a complex coding assistant — runs on the same fundamental loop:
      </p>
    </FadeInBlock>

    <!-- Loop Steps — vertical timeline -->
    <FadeInBlock client:visible delay={0.2}>
      <div style={`position: relative; padding-left: 2.5rem; margin-bottom: 3rem;`}>
        <div style={`position: absolute; left: 7px; top: 8px; bottom: 8px; width: 1px; background: linear-gradient(to bottom, ${chapter.accent}, ${chapter.accent}20);`}></div>
        {[
          { word: 'Goal.', desc: 'Receive a high-level objective from the human.' },
          { word: 'Plan.', desc: 'Break the goal into a sequence of concrete steps.' },
          { word: 'Execute.', desc: 'Run each step, using the right tool for each task.' },
          { word: 'Observe.', desc: 'Check the result. Did it work? Is the data good?' },
          { word: 'Iterate.', desc: 'If something\'s off, adjust the plan and try again.' },
        ].map((step, i) => (
          <div style={`position: relative; padding-bottom: ${i < 4 ? '1.75rem' : '0'};`}>
            <div style={`position: absolute; left: -2.5rem; top: 6px; width: 15px; height: 15px; border-radius: 50%; border: 2px solid ${chapter.accent}; background: var(--color-cream);`}></div>
            <p style="margin: 0; font-size: 1rem; line-height: 1.5;">
              <strong style={`color: ${chapter.accent}; font-family: var(--font-heading); font-weight: 700;`}>{step.word}</strong>
              <span style="opacity: 0.7;"> {step.desc}</span>
            </p>
          </div>
        ))}
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.3}>
      <p class="text-lg leading-[1.85] mb-10">
        The key word is <em>loop</em>. An agent doesn't just plan once and execute blindly. It plans, acts, observes the result, and adjusts. The best agents are the ones that recover gracefully when step three goes sideways.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.35}>
      <div class="pull-quote" style={`border-color: ${chapter.accent};`}>
        A chatbot is a single turn. An agent is a whole conversation — with itself, its tools, and the world.
      </div>
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ ANATOMY OF AN AGENT ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <AccentBar color={chapter.accent} className="w-16 mb-10" client:visible />
      <h2 class="mb-8" style="font-family: var(--font-heading);">
        Anatomy of an Agent
      </h2>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-14">
        Under the hood, every agent has five components. You can think of them as the organs of an artificial coworker:
      </p>
    </FadeInBlock>

    <!-- Architecture components -->
    <div style="display: flex; flex-direction: column; gap: 2rem; margin-bottom: 3rem;">
      {[
        { letter: 'G', name: 'Goal', color: '#E94560', text: 'What is this agent trying to accomplish? Without a clear goal, the agent has no way to decide if it\'s done. "Research Mars" isn\'t a goal. "Write a 500-word summary of Mars colonization challenges, cited with sources" is.' },
        { letter: 'P', name: 'Planner', color: '#7B61FF', text: 'The brain. It takes a goal and decomposes it into a sequence of steps. The best planners create flexible plans that can adapt when a step fails. Bad planners create rigid scripts that break at the first surprise.' },
        { letter: 'T', name: 'Tools', color: '#0EA5E9', text: 'The hands. Search engines, code interpreters, file readers, APIs, calculators — agents don\'t just think, they act. Each tool has specific inputs and outputs the agent must learn to use correctly.' },
        { letter: 'M', name: 'Memory', color: '#16C79A', text: 'The notebook. Agents need to remember what they\'ve done, what they\'ve found, and what went wrong. Without memory, an agent in a loop might repeat the same failing action forever.' },
        { letter: 'E', name: 'Evaluator', color: '#F5A623', text: 'The inner critic. After each step, the agent checks: did this work? Is this data reliable? Am I closer to the goal? The evaluator is what separates an agent from a script that just runs and hopes for the best.' },
      ].map((block, i) => (
        <FadeInBlock client:visible delay={i * 0.08}>
          <div style={`display: flex; gap: 1.5rem; align-items: flex-start;`}>
            <div style={`flex-shrink: 0; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: var(--font-heading); font-size: 1.1rem; font-weight: 800; color: white; background: ${block.color};`}>
              {block.letter}
            </div>
            <div style="flex: 1;">
              <p style={`font-family: var(--font-heading); font-size: 1.1rem; font-weight: 700; color: ${block.color}; margin: 0 0 0.35rem; line-height: 1.3;`}>
                {block.name}
              </p>
              <p style="font-size: 1rem; line-height: 1.75; color: var(--color-deep); opacity: 0.75; margin: 0;">
                {block.text}
              </p>
            </div>
          </div>
        </FadeInBlock>
      ))}
    </div>

    <FadeInBlock client:visible delay={0.5}>
      <div class="insight-box">
        <p style={`font-family: var(--font-heading); font-size: 0.85rem; font-weight: 700; color: ${chapter.accent}; margin: 0 0 0.5rem;`}>Key insight</p>
        <p style="font-size: 1rem; line-height: 1.75; margin: 0;">
          Most agent failures aren't intelligence failures — they're architecture failures. An agent with great language skills but no evaluator is like a brilliant person who never checks their work.
        </p>
      </div>
    </FadeInBlock>
  </section>

  <!-- ═══ WIDGET: AGENT BLUEPRINT ═══ -->
  <section class="max-w-[900px] mx-auto px-6 md:px-10 py-8">
    <FadeInBlock client:visible>
      <AgentBlueprint client:visible />
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ WHEN AGENTS FAIL ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <AccentBar color={chapter.accent} className="w-16 mb-10" client:visible />
      <h2 class="mb-8" style="font-family: var(--font-heading);">
        When Agents Fail
      </h2>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-10">
        Agents don't fail like chatbots. A chatbot gives you a bad answer and waits. An agent gives itself a bad answer, <em>acts on it</em>, then uses the broken result to make the next decision. Failures compound.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.15}>
      <p class="text-lg leading-[1.85] mb-10">
        There are three classic ways agents go wrong:
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.2}>
      <div class="prompt-block mb-10" style={`--accent: ${chapter.accent};`}>
        <div style={`position:absolute;top:-1px;left:2rem;right:2rem;height:2px;border-radius:1px;background:${chapter.accent};`}></div>
        <span class="prompt-block-label" style={`color: ${chapter.accent};`}>Failure Mode 1: The Infinite Loop</span>
        <p class="m-0 leading-relaxed" style="color: var(--color-deep);">
          The agent gets stuck repeating the same action. A research agent keeps searching for "one more source" and never starts writing. Without a stopping condition, it runs until you pull the plug — or run out of API credits.
        </p>
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.25}>
      <div class="prompt-block mb-10" style={`--accent: #7B61FF;`}>
        <div style={`position:absolute;top:-1px;left:2rem;right:2rem;height:2px;border-radius:1px;background:#7B61FF;`}></div>
        <span class="prompt-block-label" style="color: #7B61FF;">Failure Mode 2: Wrong Tool</span>
        <p class="m-0 leading-relaxed" style="color: var(--color-deep);">
          The agent selects a tool that can't do the job. It tries to web-search for a file on your hard drive, or calls a calculator to summarize an essay. It's not that the agent is stupid — it just picked from its toolbox without checking if the tool fits the task.
        </p>
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.3}>
      <div class="prompt-block mb-10" style={`--accent: #F5A623;`}>
        <div style={`position:absolute;top:-1px;left:2rem;right:2rem;height:2px;border-radius:1px;background:#F5A623;`}></div>
        <span class="prompt-block-label" style="color: #F5A623;">Failure Mode 3: Hallucinated Actions</span>
        <p class="m-0 leading-relaxed" style="color: var(--color-deep);">
          The agent invents tools or APIs that don't exist, then "calls" them with fake results. When the fake call fails, it sometimes fabricates the data it was supposed to get. Double hallucination: fake tool, fake output.
        </p>
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.35}>
      <p class="text-lg leading-[1.85]">
        The fix is always the same principle: <strong>design for the unhappy path.</strong> Max iterations, tool validation, output verification, and human checkpoints. The goal isn't to prevent all failure — it's to make failure recoverable.
      </p>
    </FadeInBlock>
  </section>

  <!-- ═══ WIDGET: FAILURE MODES LAB ═══ -->
  <section class="max-w-[900px] mx-auto px-6 md:px-10 py-8">
    <FadeInBlock client:visible>
      <FailureModesLab client:visible />
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ THE POWER OF MANY: MULTI-AGENT SYSTEMS ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <AccentBar color={chapter.accent} className="w-16 mb-10" client:visible />
      <h2 class="mb-8" style="font-family: var(--font-heading);">
        The Power of Many
      </h2>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-10">
        One agent is useful. Multiple agents, working together, can tackle problems that would overwhelm any single system. The trick is specialization.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.15}>
      <div class="pull-quote" style={`border-color: ${chapter.accent};`}>
        Think of it like a newsroom. You don't ask the same person to investigate the story, write the article, and edit it for publication. Each role requires a different mindset, different tools, and different standards.
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.2}>
      <p class="text-lg leading-[1.85] mb-10">
        Multi-agent systems work the same way. A <strong>Researcher</strong> agent gathers information. A <strong>Writer</strong> agent turns raw notes into polished prose. An <strong>Editor</strong> agent reviews, fact-checks, and suggests improvements. Each agent has its own system prompt, its own tools, and its own success criteria.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.25}>
      <p class="text-lg leading-[1.85] mb-10">
        The critical question in multi-agent design isn't "how smart is each agent?" It's <strong>"how good is the handoff?"</strong> When the Researcher passes notes to the Writer, are those notes structured clearly? When the Writer passes a draft to the Editor, does the Editor have enough context to give useful feedback?
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.3}>
      <div class="insight-box">
        <p style={`font-family: var(--font-heading); font-size: 0.85rem; font-weight: 700; color: ${chapter.accent}; margin: 0 0 0.5rem;`}>Key insight</p>
        <p style="font-size: 1rem; line-height: 1.75; margin: 0;">
          The handoff document is the most important artifact in a multi-agent system. A brilliant writer can't save sloppy research notes. The interface between agents is where quality is won or lost.
        </p>
      </div>
    </FadeInBlock>
  </section>

  <!-- ═══ WIDGET: HANDOFF CHAIN ═══ -->
  <section class="max-w-[900px] mx-auto px-6 md:px-10 py-8">
    <FadeInBlock client:visible>
      <HandoffChain client:visible />
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ HUMAN IN THE LOOP ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <AccentBar color={chapter.accent} className="w-16 mb-10" client:visible />
      <h2 class="mb-8" style="font-family: var(--font-heading);">
        The Human in the Loop
      </h2>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] mb-10">
        The most powerful agent architecture isn't fully autonomous. It's the one that knows when to stop and ask a human.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.15}>
      <p class="text-lg leading-[1.85] mb-10">
        Think about it in terms of stakes. Summarizing an article? Let the agent run. Sending an email to your boss? Maybe ask first. Deleting files or making a purchase? Definitely ask first. The level of autonomy should match the level of consequences.
      </p>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.2}>
      <div style={`display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2.5rem;`}>
        {[
          { stakes: 'Low stakes', example: 'Searching the web, summarizing text, generating ideas', level: 'Let it run', color: '#16C79A' },
          { stakes: 'Medium stakes', example: 'Sending messages, editing shared documents, making API calls', level: 'Confirm before acting', color: '#F5A623' },
          { stakes: 'High stakes', example: 'Deleting data, spending money, publishing content, contacting people', level: 'Human decides', color: '#E94560' },
        ].map((tier, i) => (
          <FadeInBlock client:visible delay={0.25 + i * 0.08}>
            <div style={`display: flex; gap: 1rem; align-items: flex-start; padding: 1rem 1.25rem; border-radius: 10px; border: 1px solid ${tier.color}20; background: ${tier.color}06;`}>
              <div style={`flex-shrink: 0; width: 10px; height: 10px; border-radius: 50%; background: ${tier.color}; margin-top: 6px;`}></div>
              <div style="flex: 1;">
                <p style={`font-family: var(--font-heading); font-size: 0.95rem; font-weight: 700; color: ${tier.color}; margin: 0 0 0.2rem;`}>
                  {tier.stakes}: {tier.level}
                </p>
                <p style="font-size: 0.88rem; line-height: 1.6; color: var(--color-deep); opacity: 0.7; margin: 0;">
                  {tier.example}
                </p>
              </div>
            </div>
          </FadeInBlock>
        ))}
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.5}>
      <p class="text-lg leading-[1.85]">
        The best agent builders aren't the ones who make their agents do everything autonomously. They're the ones who design <strong>thoughtful checkpoints</strong> — moments where the agent pauses, shows its work, and lets a human decide whether to continue.
      </p>
    </FadeInBlock>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ KEY CONCEPTS ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-16">
    <FadeInBlock client:visible>
      <h2 class="mb-12" style="font-family: var(--font-heading);">Key Concepts</h2>
    </FadeInBlock>

    <div style="display: flex; flex-direction: column; gap: 1rem;">
      {chapter.concepts.map((concept, i) => (
        <FadeInBlock client:visible delay={i * 0.08}>
          <ConceptCard
            name={concept.name}
            description={concept.description}
            accent={chapter.accent}
            index={i}
            client:load
          />
        </FadeInBlock>
      ))}
    </div>
  </section>

  <Divider accent={chapter.accent} client:load />

  <!-- ═══ CLOSING ═══ -->
  <section class="max-w-[680px] mx-auto px-6 md:px-10 py-24">
    <FadeInBlock client:visible>
      <div class="pull-quote" style="border-color: var(--color-navy); max-width: 50ch; margin: 0 auto 2rem;">
        An agent is only as good as its architecture. The smartest AI in the world, deployed without guardrails, is just a fast way to make expensive mistakes.
      </div>
    </FadeInBlock>

    <FadeInBlock client:visible delay={0.1}>
      <p class="text-lg leading-[1.85] text-center mx-auto" style="max-width: 55ch;">
        Now you know how agents think, act, fail, and collaborate. In the next chapter, we put all of this into practice with the most powerful coding agent available — Claude Code.
      </p>
    </FadeInBlock>
  </section>

</ChapterLayout>
