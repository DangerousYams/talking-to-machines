---
import '../styles/global.css';
import ScrollProgress from '../components/scroll/ScrollProgress';
import ChapterNav from '../components/ui/ChapterNav';
import PaywallGate from '../components/ui/PaywallGate';
import QuotaCounter from '../components/ui/QuotaCounter';
import PageViewTracker from '../components/analytics/PageViewTracker';
import { ListenController } from '../components/chapter/ChapterBeats';
import ListenButton from '../components/chapter/ListenButton';
import { chapters, type Chapter } from '../data/chapters';

interface Props {
  chapter: Chapter;
}

const { chapter } = Astro.props;
const prev = chapters.find((c) => c.number === chapter.number - 1);
const next = chapters.find((c) => c.number === chapter.number + 1);
const needsPaywall = chapter.number > 1;
const hasBeats = chapter.beats && chapter.beats.length > 0;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={`Chapter ${chapter.number}: ${chapter.title} — ${chapter.hook}`} />
    <meta property="og:title" content={`${chapter.title} — Talking to Machines`} />
    <meta property="og:description" content={chapter.hook} />
    <title>Ch {chapter.number}: {chapter.title} — Talking to Machines</title>
    <script define:vars={{ slug: chapter.slug }}>
      // Redirect to cards on mobile UA OR narrow viewport (DevTools responsive mode)
      const params = new URLSearchParams(window.location.search);
      const forceScroll = params.get('force') === 'scroll' || params.has('desktop');
      const forceMobile = params.has('mobile');
      const isMobileUA = /Mobile|Android|iPhone|iPod|webOS|BlackBerry|Opera Mini|IEMobile/i.test(navigator.userAgent);
      const isNarrowViewport = window.innerWidth <= 768;

      if (!forceScroll && (forceMobile || isMobileUA || isNarrowViewport)) {
        window.location.replace('/' + slug + '-cards' + window.location.search);
      }
    </script>
  </head>
  <body class="bg-cream text-deep min-h-screen">
    <ScrollProgress color={chapter.accent} client:load />
    <PageViewTracker variant="scroll" chapter={chapter.slug} client:load />

    <!-- Floating header — minimal, stays out of the way -->
    <header class="fixed top-0 left-0 right-0 z-40 transition-all duration-500">
      <div class="bg-cream/90 backdrop-blur-lg border-b border-deep/[0.04]">
        <div class="max-w-[960px] mx-auto px-6 md:px-10 h-12 flex items-center justify-between">
          <a
            href="/"
            class="text-[13px] tracking-[0.06em] no-underline text-subtle/70 hover:text-deep transition-colors"
            style="font-family: var(--font-heading); font-weight: 500;"
          >
            Talking to Machines
          </a>
          <div class="flex items-center gap-3">
            <ListenButton accentColor={chapter.accent} client:load />
            <QuotaCounter client:load />
            <span class="text-[11px] tracking-[0.08em] uppercase text-subtle/50" style="font-family: var(--font-mono);">
              {chapter.number} / {chapters.length}
            </span>
          </div>
        </div>
      </div>
    </header>

    {needsPaywall && (
      <PaywallGate chapterTitle={chapter.title} accentColor={chapter.accent} client:load />
    )}

    <main class="pt-12">
      <slot />
    </main>

    <ListenController accentColor={chapter.accent} chapterSlug={chapter.slug} client:load />

    <ChapterNav prev={prev} next={next} client:load />

    <!-- Footer -->
    <footer class="py-20 px-6">
      <div class="max-w-[680px] mx-auto text-center">
        <div class="flex items-center justify-center gap-3 mb-4 opacity-30">
          <div class="w-8 h-px bg-deep"></div>
          <svg width="8" height="8" viewBox="0 0 8 8" fill="none"><path d="M4 0l4 4-4 4L0 4z" fill="currentColor"/></svg>
          <div class="w-8 h-px bg-deep"></div>
        </div>
        <p class="text-[13px] text-subtle/60" style="font-family: var(--font-body);">
          <a href="/" class="no-underline text-subtle/60 hover:text-deep transition-colors">Talking to Machines</a>
        </p>
      </div>
    </footer>
  </body>
</html>
